<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Quality Control Receiving Form - Form 13 - FS Monitoring</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f3f4f6;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(5, 150, 105, 0.3);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .header-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            border: none;
        }
        
        .btn-primary {
            background: white;
            color: #059669;
        }
        
        .btn-primary:hover {
            background: #ecfdf5;
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.25);
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 1.5rem;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .card-header h2 {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
        }
        
        .filter-bar {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .form-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #059669;
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
        }
        
        .document-info {
            display: flex;
            gap: 2rem;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        
        .document-info .info-item {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .document-info .label {
            font-size: 0.75rem;
            color: #6b7280;
            text-transform: uppercase;
        }
        
        .document-info .value {
            font-weight: 600;
            color: #1f2937;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1400px;
        }
        
        th, td {
            padding: 0.75rem 0.5rem;
            text-align: center;
            border: 1px solid #e5e7eb;
            font-size: 0.8rem;
        }
        
        th {
            background: #059669;
            color: white;
            font-weight: 600;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
        }
        
        th.section-header {
            background: #047857;
        }
        
        tr:nth-child(even) {
            background: #f9fafb;
        }
        
        tr:hover {
            background: #ecfdf5;
        }
        
        td input[type="text"],
        td input[type="number"],
        td input[type="time"],
        td input[type="date"],
        td select,
        td textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        
        td input:focus,
        td select:focus,
        td textarea:focus {
            outline: none;
            border-color: #059669;
            box-shadow: 0 0 0 2px rgba(5, 150, 105, 0.1);
        }
        
        td textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        .checkbox-cell {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .checkbox-cell input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #059669;
        }
        
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .status-pass {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-review {
            background: #fef3c7;
            color: #92400e;
        }
        
        .duration-cell {
            font-weight: 600;
        }
        
        .duration-ok {
            color: #059669;
        }
        
        .duration-warning {
            color: #f59e0b;
        }
        
        .duration-danger {
            color: #ef4444;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.25rem;
            justify-content: center;
        }
        
        .add-row-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            background: #ecfdf5;
            border: 2px dashed #059669;
            border-radius: 8px;
            color: #059669;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 1rem;
        }
        
        .add-row-btn:hover {
            background: #d1fae5;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .modal-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }
        
        .modal-body .form-group {
            margin-bottom: 1rem;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        
        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        
        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }
        
        .hidden {
            display: none !important;
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .filter-bar {
                flex-direction: column;
                width: 100%;
            }
            
            .form-group {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div>
                <h1>üì¶ Quality Control Receiving - Form 13</h1>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="saveAllEntries()">üíæ Save All</button>
                <a href="/quality-control-receiving" class="btn btn-secondary">‚Üê Back</a>
                <a href="/dashboard" class="btn btn-secondary">üè† Dashboard</a>
            </div>
        </div>
    </header>
    
    <div class="container">
        <!-- Alert Messages -->
        <div id="alertContainer"></div>
        
        <!-- Date Selection Card -->
        <div class="card">
            <div class="filter-bar">
                <div class="form-group">
                    <label for="logDate">üìÖ Date</label>
                    <input type="date" id="logDate" onchange="loadDocument()">
                </div>
                <div class="form-group">
                    <label for="filledBy">üë§ Filled By</label>
                    <input type="text" id="filledBy" readonly>
                </div>
                <button class="btn btn-success" onclick="createOrLoadDocument()">üìã Load/Create Document</button>
            </div>
            
            <div class="document-info" id="documentInfo" style="display: none;">
                <div class="info-item">
                    <span class="label">Document #:</span>
                    <span class="value" id="documentNumber">-</span>
                </div>
                <div class="info-item">
                    <span class="label">Status:</span>
                    <span class="value" id="documentStatus">-</span>
                </div>
                <div class="info-item">
                    <span class="label">Entries:</span>
                    <span class="value" id="entryCount">0</span>
                </div>
            </div>
        </div>
        
        <!-- Entries Table Card -->
        <div class="card" id="entriesCard" style="display: none;">
            <div class="card-header">
                <h2>üìù Product Receiving Entries</h2>
                <button class="btn btn-success" onclick="showAddEntryModal()">‚ûï Add Entry</button>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th rowspan="2" style="min-width: 50px;">#</th>
                            <th colspan="2" class="section-header">Product Info</th>
                            <th colspan="6" class="section-header">Receiving</th>
                            <th colspan="1" class="section-header">Transfer to Storage</th>
                            <th rowspan="2" style="min-width: 80px;">Duration (min)</th>
                            <th rowspan="2" style="min-width: 120px;">Comments</th>
                            <th rowspan="2" style="min-width: 120px;">Corrective Action</th>
                            <th rowspan="2" style="min-width: 100px;">QC Signature</th>
                            <th rowspan="2" style="min-width: 60px;">Status</th>
                            <th rowspan="2" style="min-width: 80px;">Actions</th>
                        </tr>
                        <tr>
                            <th style="min-width: 180px;">Product / Prod Date / Exp Date</th>
                            <th style="min-width: 120px;">Supplier</th>
                            <th style="min-width: 80px;">Time</th>
                            <th style="min-width: 80px;">Temp (¬∞C)</th>
                            <th style="min-width: 60px;">Area Clean</th>
                            <th style="min-width: 60px;">Well Packed</th>
                            <th style="min-width: 60px;">Inspected</th>
                            <th style="min-width: 60px;">No Hazards</th>
                            <th style="min-width: 60px;">Truck Clean</th>
                            <th style="min-width: 80px;">Time In</th>
                        </tr>
                    </thead>
                    <tbody id="entriesTableBody">
                        <tr>
                            <td colspan="15" style="text-align: center; padding: 2rem; color: #6b7280;">
                                No entries yet. Click "Add Entry" to start.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Entry Modal -->
    <div class="modal" id="entryModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 id="modalTitle">‚ûï Add New Entry</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <form id="entryForm" onsubmit="saveEntry(event)">
                <input type="hidden" id="entryId">
                
                <div class="modal-body">
                    <h4 style="margin-bottom: 1rem; color: #059669;">üì¶ Product Information</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="productName">Product Name *</label>
                            <input type="text" id="productName" required>
                        </div>
                        <div class="form-group">
                            <label for="foodCategory">Food Category *</label>
                            <select id="foodCategory" required onchange="onFoodCategoryChange()">
                                <option value="">-- Select Category --</option>
                            </select>
                            <small id="tempRangeHint" style="color: #6b7280; font-size: 0.75rem;"></small>
                        </div>
                        <div class="form-group">
                            <label for="supplierName">Supplier</label>
                            <select id="supplierName" onchange="toggleOtherSupplier()">
                                <option value="">-- Select Supplier --</option>
                            </select>
                            <input type="text" id="otherSupplierName" placeholder="Enter supplier name" style="display: none; margin-top: 0.5rem;">
                        </div>
                        <div class="form-group">
                            <label for="productionDate">Production Date</label>
                            <input type="date" id="productionDate">
                        </div>
                        <div class="form-group">
                            <label for="productExpiry">Expiry Date *</label>
                            <input type="date" id="productExpiry" required>
                        </div>
                    </div>
                    
                    <h4 style="margin: 1.5rem 0 1rem; color: #059669;">üì• Receiving Details</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="receivingTime">Receiving Time *</label>
                            <input type="time" id="receivingTime" required>
                        </div>
                        <div class="form-group">
                            <label for="receivingTemp">Product Temperature (¬∞C)</label>
                            <input type="number" id="receivingTemp" step="0.1" onchange="checkTemperatureDeviation()">
                        </div>
                    </div>
                    <div id="tempDeviationWarning" style="display: none; background: #fef2f2; border: 1px solid #fecaca; padding: 0.75rem; border-radius: 8px; margin-top: 0.5rem; color: #991b1b; font-size: 0.875rem;">
                        ‚ö†Ô∏è <strong>Temperature Deviation Detected!</strong> Product temperature is outside the acceptable range. Corrective action is required.
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="receivingAreaClean"> Receiving Area Clean
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="productWellCovered"> Product Well Covered/Packed
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="packOpenedInspected"> Pack Opened & Inspected
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="noPhysicalHazards"> No Physical Hazards
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="truckCleanliness"> Truck Cleanliness
                        </label>
                    </div>
                    
                    <h4 style="margin: 1.5rem 0 1rem; color: #059669;">‚ùÑÔ∏è Transfer to Storage</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="storageTime">Time Into Fridge/Freezer</label>
                            <input type="time" id="storageTime">
                        </div>
                    </div>
                    
                    <h4 style="margin: 1.5rem 0 1rem; color: #059669;">üìù Comments & Action</h4>
                    <div class="form-group">
                        <label for="comments">Comments</label>
                        <textarea id="comments" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="correctiveAction">Corrective Action</label>
                        <textarea id="correctiveAction" rows="2"></textarea>
                    </div>
                    
                    <h4 style="margin: 1.5rem 0 1rem; color: #059669;">‚úçÔ∏è Signature</h4>
                    <div class="form-group">
                        <label for="qcSignature">Quality Controller Signature</label>
                        <input type="text" id="qcSignature" placeholder="Type your name to sign">
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="saveEntry(event, 'draft')" style="background: #f59e0b; color: white;">üìù Save Draft</button>
                    <button type="submit" class="btn btn-success">‚úÖ Submit</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // Global variables
        let currentDocument = null;
        let currentUser = null;
        let suppliers = [];
        let foodCategories = [];
        let entries = [];
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Set today's date
            document.getElementById('logDate').value = new Date().toISOString().split('T')[0];
            
            // Load current user
            await loadCurrentUser();
            
            // Load suppliers
            await loadSuppliers();
            
            // Load food categories
            await loadFoodCategories();
            
            // Check if editing existing document
            const urlParams = new URLSearchParams(window.location.search);
            const docId = urlParams.get('doc');
            if (docId) {
                await loadExistingDocument(docId);
            }
        });
        
        // Load existing document for editing
        async function loadExistingDocument(docId) {
            try {
                console.log('Loading existing document:', docId);
                const response = await fetch(`/quality-control-receiving/api/documents/${docId}?_t=${Date.now()}`);
                console.log('Document response status:', response.status);
                
                if (!response.ok) {
                    showAlert('Document not found', 'error');
                    return;
                }
                
                const data = await response.json();
                console.log('Document data received:', data);
                console.log('Entries in response:', data.entries);
                
                currentDocument = data.document;
                
                // Set date (format for input)
                const logDate = new Date(currentDocument.log_date).toISOString().split('T')[0];
                document.getElementById('logDate').value = logDate;
                
                // Set filled by
                document.getElementById('filledBy').value = currentDocument.filled_by;
                
                // Show document info
                document.getElementById('documentInfo').style.display = 'flex';
                document.getElementById('documentNumber').textContent = currentDocument.document_number;
                document.getElementById('documentStatus').textContent = currentDocument.status;
                
                // Show entries card
                document.getElementById('entriesCard').style.display = 'block';
                
                // Load entries
                entries = data.entries || [];
                console.log('Setting entries array:', entries);
                console.log('Entries count:', entries.length);
                
                document.getElementById('entryCount').textContent = entries.length;
                renderEntriesTable();
                
                showAlert('Document loaded for editing', 'success');
            } catch (err) {
                console.error('Error loading document:', err);
                showAlert('Failed to load document', 'error');
            }
        }
        
        // Load current user
        async function loadCurrentUser() {
            try {
                const response = await fetch('/quality-control-receiving/api/current-user?_t=' + Date.now());
                console.log('Current user response status:', response.status);
                currentUser = await response.json();
                console.log('Current user data:', currentUser);
                document.getElementById('filledBy').value = currentUser.name || 'User';
                console.log('Set filledBy to:', currentUser.name);
            } catch (err) {
                console.error('Error loading user:', err);
                document.getElementById('filledBy').value = 'Unknown User';
            }
        }
        
        // Load suppliers for dropdown
        async function loadSuppliers() {
            try {
                const response = await fetch('/quality-control-receiving/api/suppliers?_t=' + Date.now());
                suppliers = await response.json();
                
                const select = document.getElementById('supplierName');
                select.innerHTML = '<option value="">-- Select Supplier --</option>';
                suppliers.forEach(s => {
                    select.innerHTML += `<option value="${s.supplier_name}">${s.supplier_name}</option>`;
                });
                select.innerHTML += '<option value="__OTHER__">Other (Enter manually)</option>';
            } catch (err) {
                console.error('Error loading suppliers:', err);
            }
        }
        
        // Toggle other supplier text input
        function toggleOtherSupplier() {
            const select = document.getElementById('supplierName');
            const otherInput = document.getElementById('otherSupplierName');
            if (select.value === '__OTHER__') {
                otherInput.style.display = 'block';
                otherInput.focus();
            } else {
                otherInput.style.display = 'none';
                otherInput.value = '';
            }
        }
        
        // Load food categories for dropdown
        async function loadFoodCategories() {
            try {
                const response = await fetch('/quality-control-receiving/api/food-categories?_t=' + Date.now());
                foodCategories = await response.json();
                
                const select = document.getElementById('foodCategory');
                select.innerHTML = '<option value="">-- Select Category --</option>';
                foodCategories.forEach(cat => {
                    select.innerHTML += `<option value="${cat.id}" data-min="${cat.min_temp}" data-max="${cat.max_temp}">${cat.category_name} (${cat.min_temp}¬∞C to ${cat.max_temp}¬∞C)</option>`;
                });
            } catch (err) {
                console.error('Error loading food categories:', err);
            }
        }
        
        // Handle food category change - show temp range hint
        function onFoodCategoryChange() {
            const select = document.getElementById('foodCategory');
            const hint = document.getElementById('tempRangeHint');
            const selectedOption = select.options[select.selectedIndex];
            
            if (select.value && selectedOption.dataset.min !== undefined) {
                hint.textContent = `Acceptable range: ${selectedOption.dataset.min}¬∞C to ${selectedOption.dataset.max}¬∞C`;
                hint.style.display = 'block';
            } else {
                hint.textContent = '';
                hint.style.display = 'none';
            }
            
            // Re-check temperature if already entered
            checkTemperatureDeviation();
        }
        
        // Check if temperature is within acceptable range for selected category
        function checkTemperatureDeviation() {
            const categorySelect = document.getElementById('foodCategory');
            const tempInput = document.getElementById('receivingTemp');
            const warning = document.getElementById('tempDeviationWarning');
            const correctiveSection = document.getElementById('correctiveAction');
            
            const temp = parseFloat(tempInput.value);
            const selectedOption = categorySelect.options[categorySelect.selectedIndex];
            
            if (!categorySelect.value || isNaN(temp) || !selectedOption.dataset.min) {
                warning.style.display = 'none';
                tempInput.style.borderColor = '#d1d5db';
                return false;
            }
            
            const minTemp = parseFloat(selectedOption.dataset.min);
            const maxTemp = parseFloat(selectedOption.dataset.max);
            
            if (temp < minTemp || temp > maxTemp) {
                warning.style.display = 'block';
                tempInput.style.borderColor = '#ef4444';
                tempInput.style.background = '#fef2f2';
                
                // Highlight corrective action field
                if (correctiveSection) {
                    correctiveSection.style.borderColor = '#ef4444';
                    correctiveSection.style.background = '#fef2f2';
                    correctiveSection.placeholder = 'REQUIRED - Enter corrective action for temperature deviation';
                    correctiveSection.required = true;
                }
                return true; // Has deviation
            } else {
                warning.style.display = 'none';
                tempInput.style.borderColor = '#10b981';
                tempInput.style.background = '#ecfdf5';
                
                if (correctiveSection) {
                    correctiveSection.style.borderColor = '#d1d5db';
                    correctiveSection.style.background = '';
                    correctiveSection.placeholder = '';
                    correctiveSection.required = false;
                }
                return false; // No deviation
            }
        }
        
        // Create or load document for selected date
        async function createOrLoadDocument() {
            const logDate = document.getElementById('logDate').value;
            const filledBy = document.getElementById('filledBy').value;
            
            if (!logDate) {
                showAlert('Please select a date', 'error');
                return;
            }
            
            try {
                const response = await fetch('/quality-control-receiving/api/documents', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ log_date: logDate, filled_by: filledBy })
                });
                
                const data = await response.json();
                console.log('Document API response:', data);
                
                currentDocument = data.document;
                console.log('currentDocument set to:', currentDocument);
                
                if (!currentDocument) {
                    showAlert('Failed to load document - no document returned', 'error');
                    return;
                }
                
                // Show document info
                document.getElementById('documentInfo').style.display = 'flex';
                document.getElementById('documentNumber').textContent = currentDocument.document_number;
                document.getElementById('documentStatus').textContent = currentDocument.status;
                
                // Show entries card
                document.getElementById('entriesCard').style.display = 'block';
                
                // Load entries
                await loadEntries();
                
                showAlert(data.exists ? 'Document loaded successfully' : 'New document created', 'success');
            } catch (err) {
                console.error('Error creating/loading document:', err);
                showAlert('Failed to create/load document', 'error');
            }
        }
        
        // Load document (alias)
        function loadDocument() {
            createOrLoadDocument();
        }
        
        // Load entries for current document
        async function loadEntries() {
            console.log('loadEntries called, currentDocument:', currentDocument);
            if (!currentDocument) {
                console.log('No currentDocument, returning');
                return;
            }
            
            try {
                const url = `/quality-control-receiving/api/entries?document_id=${currentDocument.id}`;
                console.log('Fetching entries from:', url);
                
                const response = await fetch(url);
                console.log('Response status:', response.status);
                
                entries = await response.json();
                
                console.log('Loaded entries:', entries);
                
                document.getElementById('entryCount').textContent = entries.length;
                renderEntriesTable();
            } catch (err) {
                console.error('Error loading entries:', err);
            }
        }
        
        // Format time for display
        function formatTime(timeValue) {
            if (!timeValue) return '-';
            // If it's a Date object
            if (timeValue instanceof Date) {
                return timeValue.toTimeString().substring(0, 5);
            }
            // If it's a string
            if (typeof timeValue === 'string') {
                // Handle ISO date strings like "1970-01-01T16:54:00.000Z"
                if (timeValue.includes('T')) {
                    const timePart = timeValue.split('T')[1];
                    return timePart ? timePart.substring(0, 5) : '-';
                }
                // Handle time strings like "18:54:00.0000000" or "18:54:00"
                return timeValue.substring(0, 5);
            }
            return '-';
        }
        
        // Render entries table
        function renderEntriesTable() {
            console.log('renderEntriesTable called, entries:', entries);
            console.log('entries type:', typeof entries);
            console.log('entries isArray:', Array.isArray(entries));
            console.log('entries length:', entries ? entries.length : 'null/undefined');
            
            const tbody = document.getElementById('entriesTableBody');
            
            if (!entries || !Array.isArray(entries) || entries.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="15" style="text-align: center; padding: 2rem; color: #6b7280;">
                            No entries yet. Click "Add Entry" to start.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = entries.map((entry, index) => {
                const supplierName = entry.supplier_name || '-';
                
                // Format duration with color coding
                let durationClass = 'duration-ok';
                if (entry.duration_minutes > 30) durationClass = 'duration-warning';
                if (entry.duration_minutes > 60) durationClass = 'duration-danger';
                
                // Format times
                const recTime = formatTime(entry.receiving_time);
                const stoTime = formatTime(entry.storage_time);
                
                // Format dates
                const prodDate = entry.production_date ? new Date(entry.production_date).toLocaleDateString() : '-';
                const expDate = entry.product_expiry_date ? new Date(entry.product_expiry_date).toLocaleDateString() : '-';
                
                // Check if draft
                const isDraft = entry.entry_status === 'draft';
                const draftStyle = isDraft ? 'background: #fef3c7; border-left: 4px solid #f59e0b;' : '';
                const draftBadge = isDraft ? '<span style="background: #f59e0b; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; margin-left: 5px;">DRAFT</span>' : '';
                
                return `
                    <tr style="${draftStyle}">
                        <td>${index + 1}</td>
                        <td style="text-align: left;">
                            <strong>${entry.product_name}</strong>${draftBadge}<br>
                            <small style="color: #6b7280;">Prod: ${prodDate}</small><br>
                            <small style="color: #6b7280;">Exp: ${expDate}</small>
                        </td>
                        <td>${supplierName}</td>
                        <td>${recTime}</td>
                        <td>${entry.receiving_temp !== null ? entry.receiving_temp + '¬∞C' : '-'}</td>
                        <td>${renderCheckbox(entry.receiving_area_clean)}</td>
                        <td>${renderCheckbox(entry.product_well_covered)}</td>
                        <td>${renderCheckbox(entry.pack_opened_inspected)}</td>
                        <td>${renderCheckbox(entry.no_physical_hazards)}</td>
                        <td>${renderCheckbox(entry.truck_cleanliness)}</td>
                        <td>${stoTime}</td>
                        <td class="duration-cell ${durationClass}">${entry.duration_minutes !== null ? entry.duration_minutes : '-'}</td>
                        <td style="text-align: left; font-size: 0.75rem;">${entry.comments || '-'}</td>
                        <td style="text-align: left; font-size: 0.75rem;">${entry.corrective_action || '-'}</td>
                        <td>${entry.quality_controller_signature || '-'}</td>
                        <td>
                            <span class="status-badge ${entry.overall_status === 'Pass' ? 'status-pass' : 'status-review'}">
                                ${isDraft ? 'Draft' : entry.overall_status}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-primary btn-sm" onclick="editEntry(${entry.id})">${isDraft ? 'üìù Continue' : '‚úèÔ∏è'}</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteEntry(${entry.id})">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Render checkbox display
        function renderCheckbox(value) {
            return value ? '‚úÖ' : '‚ùå';
        }
        
        // Show add entry modal
        function showAddEntryModal() {
            if (!currentDocument) {
                showAlert('Please load or create a document first', 'error');
                return;
            }
            
            document.getElementById('modalTitle').textContent = '‚ûï Add New Entry';
            document.getElementById('entryForm').reset();
            document.getElementById('entryId').value = '';
            
            // Reset other supplier input
            document.getElementById('otherSupplierName').style.display = 'none';
            document.getElementById('otherSupplierName').value = '';
            
            // Reset food category hints and warning
            document.getElementById('tempRangeHint').textContent = '';
            document.getElementById('tempDeviationWarning').style.display = 'none';
            document.getElementById('receivingTemp').style.borderColor = '#d1d5db';
            document.getElementById('receivingTemp').style.background = '';
            
            // Set current time as default
            const now = new Date();
            document.getElementById('receivingTime').value = now.toTimeString().substring(0, 5);
            
            // Auto-fill QC signature with current user name
            document.getElementById('qcSignature').value = currentUser?.name || '';
            
            document.getElementById('entryModal').classList.add('active');
        }
        
        // Edit entry
        function editEntry(id) {
            console.log('editEntry called with id:', id);
            console.log('Current entries:', entries);
            
            const entry = entries.find(e => e.id === id);
            console.log('Found entry:', entry);
            
            if (!entry) {
                showAlert('Entry not found', 'error');
                return;
            }
            
            document.getElementById('modalTitle').textContent = '‚úèÔ∏è Edit Entry';
            document.getElementById('entryId').value = entry.id;
            document.getElementById('productName').value = entry.product_name;
            
            // Set food category
            document.getElementById('foodCategory').value = entry.food_category_id || '';
            onFoodCategoryChange(); // Update hint
            
            // Handle supplier - check if it's in the dropdown or should be "Other"
            const supplierSelect = document.getElementById('supplierName');
            const otherSupplierInput = document.getElementById('otherSupplierName');
            const supplierValue = entry.supplier_name || '';
            const optionExists = Array.from(supplierSelect.options).some(opt => opt.value === supplierValue && opt.value !== '__OTHER__');
            
            if (supplierValue && !optionExists) {
                supplierSelect.value = '__OTHER__';
                otherSupplierInput.style.display = 'block';
                otherSupplierInput.value = supplierValue;
            } else {
                supplierSelect.value = supplierValue;
                otherSupplierInput.style.display = 'none';
                otherSupplierInput.value = '';
            }
            
            document.getElementById('productionDate').value = entry.production_date ? entry.production_date.split('T')[0] : '';
            document.getElementById('productExpiry').value = entry.product_expiry_date ? entry.product_expiry_date.split('T')[0] : '';
            document.getElementById('receivingTime').value = entry.receiving_time ? entry.receiving_time.substring(0, 5) : '';
            document.getElementById('receivingTemp').value = entry.receiving_temp || '';
            document.getElementById('receivingAreaClean').checked = entry.receiving_area_clean;
            document.getElementById('productWellCovered').checked = entry.product_well_covered;
            document.getElementById('packOpenedInspected').checked = entry.pack_opened_inspected;
            document.getElementById('noPhysicalHazards').checked = entry.no_physical_hazards;
            document.getElementById('truckCleanliness').checked = entry.truck_cleanliness;
            document.getElementById('storageTime').value = entry.storage_time ? entry.storage_time.substring(0, 5) : '';
            document.getElementById('comments').value = entry.comments || '';
            document.getElementById('correctiveAction').value = entry.corrective_action || '';
            document.getElementById('qcSignature').value = entry.quality_controller_signature || '';
            
            document.getElementById('entryModal').classList.add('active');
        }
        
        // Save entry
        async function saveEntry(event, status = 'submitted') {
            event.preventDefault();
            
            const entryId = document.getElementById('entryId').value;
            const isDraft = status === 'draft';
            
            // For submit only - validate required fields
            if (!isDraft) {
                // Check for temperature deviation - require corrective action
                const hasDeviation = checkTemperatureDeviation();
                const correctiveAction = document.getElementById('correctiveAction').value;
                
                if (hasDeviation && !correctiveAction.trim()) {
                    showAlert('Corrective action is required when temperature is outside acceptable range', 'error');
                    document.getElementById('correctiveAction').focus();
                    return;
                }
                
                // Require signature for submit
                const signature = document.getElementById('qcSignature').value;
                if (!signature || !signature.trim()) {
                    showAlert('Signature is required to submit the entry', 'error');
                    document.getElementById('qcSignature').focus();
                    return;
                }
            }
            
            // Get supplier name - use other input if "Other" is selected
            const supplierSelect = document.getElementById('supplierName').value;
            const otherSupplier = document.getElementById('otherSupplierName').value;
            const finalSupplierName = supplierSelect === '__OTHER__' ? otherSupplier : supplierSelect;
            
            // Get food category
            const foodCategoryId = document.getElementById('foodCategory').value;
            
            const entryData = {
                document_id: currentDocument.id,
                product_name: document.getElementById('productName').value,
                food_category_id: foodCategoryId || null,
                supplier_name: finalSupplierName || null,
                production_date: document.getElementById('productionDate').value || null,
                product_expiry_date: document.getElementById('productExpiry').value || null,
                receiving_time: document.getElementById('receivingTime').value,
                receiving_temp: document.getElementById('receivingTemp').value || null,
                receiving_area_clean: document.getElementById('receivingAreaClean').checked,
                product_well_covered: document.getElementById('productWellCovered').checked,
                pack_opened_inspected: document.getElementById('packOpenedInspected').checked,
                no_physical_hazards: document.getElementById('noPhysicalHazards').checked,
                truck_cleanliness: document.getElementById('truckCleanliness').checked,
                storage_time: document.getElementById('storageTime').value || null,
                comments: document.getElementById('comments').value || null,
                corrective_action: document.getElementById('correctiveAction').value || null,
                quality_controller_signature: document.getElementById('qcSignature').value || null,
                entry_status: status
            };
            
            try {
                const url = entryId ? `/quality-control-receiving/api/entries/${entryId}` : '/quality-control-receiving/api/entries';
                const method = entryId ? 'PUT' : 'POST';
                
                console.log('Saving entry:', { url, method, entryId, entryData, status });
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(entryData)
                });
                
                console.log('Save response status:', response.status);
                const responseData = await response.json();
                console.log('Save response data:', responseData);
                
                if (response.ok) {
                    closeModal();
                    await loadEntries();
                    const message = isDraft 
                        ? 'Entry saved as draft. You can complete it later.' 
                        : (entryId ? 'Entry updated successfully' : 'Entry submitted successfully');
                    showAlert(message, 'success');
                } else {
                    showAlert('Failed to save entry: ' + (responseData.error || 'Unknown error'), 'error');
                }
            } catch (err) {
                console.error('Error saving entry:', err);
                showAlert('Failed to save entry', 'error');
            }
        }
        
        // Delete entry
        async function deleteEntry(id) {
            if (!confirm('Are you sure you want to delete this entry?')) return;
            
            try {
                const response = await fetch(`/quality-control-receiving/api/entries/${id}`, { method: 'DELETE' });
                
                if (response.ok) {
                    await loadEntries();
                    showAlert('Entry deleted successfully', 'success');
                } else {
                    showAlert('Failed to delete entry', 'error');
                }
            } catch (err) {
                console.error('Error deleting entry:', err);
                showAlert('Failed to delete entry', 'error');
            }
        }
        
        // Save all entries (placeholder - individual saves are already done)
        function saveAllEntries() {
            showAlert('All entries are automatically saved', 'info');
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('entryModal').classList.remove('active');
        }
        
        // Show alert
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 3000);
        }
        
        // Close modal on outside click
        document.getElementById('entryModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('entryModal')) {
                closeModal();
            }
        });
    </script>
</body>
</html>
